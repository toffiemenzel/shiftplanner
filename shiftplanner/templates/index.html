<!DOCTYPE html>
<html>
<head>
    <title>Psycare Shift Planner</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <a href="{{ url_for('home') }}"><h1>Psycare Shift Planner</h1></a>
    <table class="table-invisible">
        <tr>
            <td class="td-dark">
                <form action="/save_state" method="POST" enctype="multipart/form-data" style="display:inline;">
                    <button type="submit">Save progress</button>
                </form>&nbsp;&nbsp;
                <form action="/restore_state" method="POST" enctype="multipart/form-data" style="display:inline;">
                    <input type="file" id="state_file" name="state_file" accept=".json">
                    <button type="submit">Restore data</button>
                </form>&nbsp;&nbsp;
                <form action="/reset_state" method="POST" enctype="multipart/form-data" style="display:inline;">
                    <button type="submit">Reset Everything</button>
                </form>&nbsp;&nbsp;
                <form action="/load_example" method="POST" enctype="multipart/form-data" style="display:inline;">
                    <button type="submit">Example</button>
                </form>
                {% if app_data.message %}<label class="label-notification">{{ app_data.message }}</label>{% endif %}
            </td>
            <td class="td-dark align-right" width="100%">
                <label class="label-primary"><a href="{{ url_for('impressum') }}">Impressum</a>&nbsp;&nbsp;</label>
            </td>
        </tr>
    </table><br>

    <!-- Shift Definition Section -->
    <button type="button" class="collapsible">Shift Definition</button>
    <div class="content">
        <table class="table-invisible">
            <tr>
                <td width="10%" class="td-dark align-top">
                    <form action="/create_shift_table" method="POST" enctype="multipart/form-data">
                    <table class="table-invisible">
                        <tr>
                            <td colspan="2"><b>Shift Parameters</b></td>
                        </tr>
                        <tr>
                            <td>
                                <label for="first_shift_start" style="white-space: nowrap">First Shift Start:</label>
                            </td>
                            <td>
                                <input type="datetime-local" id="first_shift_start_date" name="first_shift_start_datetime" value="{{ app_data.shift_params.get('first_shift_start_datetime') }}" required>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="shift_duration_hours" style="white-space: nowrap">Shift Duration:</label>
                            </td>
                            <td>
                                <input type="number" id="shift_duration_hours" name="shift_duration_hours" value="{{ app_data.shift_params.get('shift_duration_hours', '6') }}" class="small-input" min="1" required> hours
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="num_shifts">Number of shifts:</label>
                            </td>
                            <td>
                                <input type="number" id="num_shifts" name="num_shifts" value="{{ app_data.shift_params.get('num_shifts', '10') }}" class="small-input" min="1" required> shifts
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="roles_min">Roles:</label>
                            </td>
                            <td>
                                <input type="text" id="roles_min" name="roles_min" value="{{ app_data.shift_params.get('roles_min', 'Hintergrund, Info/Chai(2), Ambulanz(3)!') }}" class="large-input" required>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td><input type="submit" value="Create Shift Table"></td>
                        </tr>
                    </table>
                    </form>
                    {% if app_data.shift_message %}
                    <label>{{ app_data.shift_message }}</label><br>
                    {% endif %}
                </td>
                <td class="td-dark-padded">
                    {% if app_data.shift_table %}
                    <label class="label-primary">This is the overview over the shifts throughout the festival. You can set the <b>minimum</b> number of people for each role and shift.</label><br>
                    <label class="label-primary">For roles where experience is checked as <i>balanced</i>, the planner will try to balance experienced and less experienced people for each shift.</label>
                    <br><br>
                    <form id="shifts-form" method="POST">
                        <table border="1">
                            <tr>
                                <th>Roles</th>
                                <th>Experience</th>
                                <th>Total</th>
                                {% for shift in app_data.shift_names %}
                                <th>{{ shift }}</th>
                                {% endfor %}
                            </tr>
                            {% for role_index in range(app_data.roles|length) %}
                            <tr>
                                <td class="centered">{{ app_data.roles[role_index] }}</td>
                                <td class="centered">
                                    <label>balanced 
                                        <input type="checkbox" name="experience_balance_{{ role_index }}" {% if app_data.role_experience_required.get(app_data.roles[role_index], False) %}checked{% endif %}>
                                    </label>
                                </td>
                                <td class="centered">{{ app_data.shift_table[role_index] | sum }}</td>
                                {% for shift_index in range(app_data.shift_params.num_shifts) %}
                                <td class="centered"><input type="number" name="shift_{{ role_index }}_{{ shift_index }}" value="{{ app_data.shift_table[role_index][shift_index] }}" min="0" class="small-input"></td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </table>
                    </form>
                    <form id="add-role-form" method="POST">
                        <button type="button" onclick="addNewRole()">Add role</button>
                        <input type="text" id="new_role_name" name="new_role_name" value="Rolename" class="medium-input" required>
                        <label class="label-primary"> with </label>
                        <input type="number" id="new_role_count" name="new_role_count" value="2" class="small-input" min="0" required>
                    </form>                        
                    <br>
                    <label id="label-total_assignments_needed" class="label-primary big">{{ app_data.get('total_assignments_needed', 0) }} shift spots</label>
                    <label id="label-recommended_nums_people" class="label-primary">/ at least {{ app_data.get('recommended_nums_people', 1) }} people with {{ (app_data.get('total_assignments_needed', 0) / app_data.get('recommended_nums_people', 1) ) | ceil }} shifts recommended</label>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>

    {% if app_data.shift_table %}
    <button type="button" id="participants" class="collapsible">Participants</button>
    <div class="content">
        
        <table class="table-invisible table-wide">
            <tr>
                <td>
                    <table class="table-invisible table-wide">
                        <tr>
                            <td>
                                <form action="/create_person_table" method="POST" enctype="multipart/form-data">
                                    <input type="submit" value="Create New Table">
                                </form>
                            </td>
                            <td>
                                <form action="/load_person_table" method="POST" enctype="multipart/form-data">
                                    <b>or upload CSV file:</b>
                                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                                    <input type="submit" value="Create Table from File">
                                </form>
                            </td>
                            <td>
                                <form action="/download_sample_file" method="POST" enctype="multipart/form-data">
                                    <b>or </b>
                                    <input type="submit" value="Download sample file">
                                </form>
                            </td>
                            <td class="align-right" width="100%">
                                <form action="/download_participants_file" method="POST" enctype="multipart/form-data">
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    <input type="submit" value="Save as csv file">
                                </form>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class="td-dark">
                    {% if app_data.persons %}
                    <a name="edit_participants"></a>
                    <h2>Edit Participants</h2>
                    <form id="participant-form" action="/change_person_table" method="POST">
                        <table border="1" id="participant-table">
                            <tr>
                                <th>Name</th>
                                <th>Gender</th>
                                {% for role in app_data.role_columns %}
                                <th>{{ role }}</th>
                                {% endfor %}
                                <th>Arrival Time</th>
                                <th>Departure Time</th>
                                <th>Num. shifts</th>
                                <th>Assign Shifts</th>
                                <th>Veto Shifts</th>
                                <th>Preferred Partners</th>
                                <!--<th>Options</th>-->
                                <th>Actions</th>
                            </tr>
                            {% for i in range(app_data.persons|length) %}
                            <tr id="row_{{ i }}">
                                <td class="centered"><input type="text" name="name_{{ i }}" value="{{ app_data.persons[i]['name'] }}" class="large-input"></td>
                                <td class="centered">
                                    <select name="gender_{{ i }}">
                                        <option value="m" {% if app_data.persons[i]['gender'] == 'm' %}selected{% endif %}>m</option>
                                        <option value="w" {% if app_data.persons[i]['gender'] == 'w' %}selected{% endif %}>w</option>
                                        <option value="d" {% if app_data.persons[i]['gender'] == 'd' %}selected{% endif %}>d</option>
                                    </select>
                                </td>
                                {% for role in app_data.role_columns %}
                                <td class="centered">
                                    <label>Available
                                        <input type="checkbox" name="roles_{{ i }}_{{ role }}_available"
                                            {% if role in app_data.persons[i]['inexperienced_roles'] or role in app_data.persons[i]['experienced_roles'] %}checked{% endif %}
                                            onclick="toggleExperienceCheckbox({{ i }}, '{{ role }}')">
                                    </label>
                                    
                                    {% if app_data.role_experience_required.get(role, False) %}
                                    <label>Experienced 
                                        <input type="checkbox" id="roles_{{ i }}_{{ role }}_experienced" name="roles_{{ i }}_{{ role }}_experienced" 
                                            {% if role in app_data.persons[i]['experienced_roles'] %}checked{% endif %}
                                            {% if role not in app_data.persons[i]['inexperienced_roles'] %}disabled{% endif %}>
                                    </label>
                                    {% endif %}
                                </td>
                                {% endfor %}
                                <td class="centered">
                                    <input type="text" name="arrival_time_{{ i }}" value="{{ app_data.persons[i]['arrival_time'] }}" class="medium-input">
                                    <label>hard
                                        <input type="checkbox" name="arrival_hard_{{ i }}" {% if app_data.persons[i]['arrival_hard'] %}checked{% endif %}>
                                    </label>
                                </td>
                                <td class="centered">
                                    <input type="text" name="departure_time_{{ i }}" value="{{ app_data.persons[i]['departure_time'] }}"  class="medium-input">
                                    <label>hard
                                        <input type="checkbox" name="departure_hard_{{ i }}" {% if app_data.persons[i]['departure_hard'] %}checked{% endif %}>
                                    </label>
                                </td>
                                <td class="centered">
                                    <input type="number" name="num_p_shifts_{{ i }}" value="{{ app_data.persons[i]['num_p_shifts'] }}"  class="small-input">
                                </td>
                                <td class="centered"><input type="text" name="assign_shifts_{{ i }}" value="{{ app_data.persons[i]['assign_shifts'] }}" class="large-input"></td>
                                <td class="centered"><input type="text" name="veto_shifts_{{ i }}" value="{{ app_data.persons[i]['veto_shifts'] }}" class="large-input"></td>
                                <td class="centered"><input type="text" name="preferred_partners_{{ i }}" value="{{ app_data.persons[i]['preferred_partners'] }}" class="large-input"></td>
                                <!--<td class="centered"><input type="text" name="options_{{ i }}" value="{{ app_data.persons[i]['options'] }}" class="large-input"></td>-->
                                <td class="centered">
                                    <button type="button" class="delete-btn" onclick="deletePerson({{ i }})">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        <table class="table-invisible">
                            <tr>
                                <td class="td-dark">
                                    <button type="button" onclick="addPerson()">Add Participant</button>
                                    <label id="label-num-persons" class="label-primary big">&nbsp;&nbsp;{{ app_data.persons | length }} persons&nbsp;&nbsp;</label>
                                    <label id="label-num-genders" class="label-primary">(w: {{ app_data.persons | selectattr('gender', 'equalto', 'w') | list | length }}, m: {{ app_data.persons | selectattr('gender', 'equalto', 'm') | list | length }}, d: {{ app_data.persons | selectattr('gender', 'equalto', 'd') | list | length }})</label>
                                    <label id="label-num-avail-shifts" class="label-primary big">&nbsp;&nbsp;{{ app_data.persons | map(attribute='num_p_shifts') | map('int') | sum }} shift spots</label>
                                    <label id="label-num-req-shifts" class="label-primary big">&nbsp;&nbsp;({{ app_data.get('total_assignments_needed', 0) }} required)</label>
                                </td>
                            </tr>
                        </table>
                    </form>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    {% endif %}
    
    {% if app_data.persons %}
    <!-- Shift Plan -->
    <button type="button" id="planner" class="collapsible">Shift Planner</button>
    <div class="content">
        <form action="/generate_plan" method="POST" enctype="multipart/form-data">
        <table class="table-invisible table-slim">
            <tr>
                <td>
                    <table class="table-invisible">
                        <tr>
                            <td colspan="2"><b>Basic Parameters</b></td>
                        </tr>
                        <tr>
                            <td><label for="opt_balance_gender">Try balance genders per shift:</label></td>
                            <td><input type="checkbox" name="opt_balance_gender" {% if app_data.opt_balance_gender %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="opt_match_partners">Try match preferred partners:</label></td>
                            <td><input type="checkbox" name="opt_match_partners" {% if app_data.opt_match_partners %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="opt_same_time_slots">Try avoid same time slots per person:</label></td>
                            <td><input type="checkbox" name="opt_same_time_slots" {% if app_data.opt_same_time_slots %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="opt_consider_travel">Consider arrival/departure time per person:</label></td>
                            <td><input type="checkbox" name="opt_consider_travel" {% if app_data.opt_consider_travel %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="opt_max_shift_dist">Try maximize time between shifts per person:</label></td>
                            <td><input type="checkbox" name="opt_max_shift_dist" {% if app_data.opt_max_shift_dist %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="opt_enforce_shift_dist">Enforce pause between shifts per person:</label></td>
                            <td><input type="checkbox" name="opt_enforce_shift_dist" {% if app_data.opt_enforce_shift_dist %}checked{% endif %}></td>
                        </tr>
                        <tr>
                            <td><label for="min_distance_between_shifts">Min. shifts off between shifts per person:</label></td>
                            <td><input type="number" id="min_distance_between_shifts" name="min_distance_between_shifts" value="{{ app_data.get('min_distance_between_shifts', '2') }}" class="small-input" min="0" required></td>
                        </tr>
                    </table>
                </td>
                <td width="25"></td>
                <td>
                    <table class="table-invisible">
                        <tr>
                            <td colspan="2"><b>Advanced Parameters</b></td>
                        </tr>
                        <tr>
                            <td><label for="partner_bonus">Partner Bonus Parameter:</label></td>
                            <td><input type="number" id="partner_bonus" name="partner_bonus" value="{{ app_data.get('partner_bonus', '10') }}" min="0" class="small-input" required></td>
                        </tr>
                        <tr>
                            <td><label for="experience_penalty">Experience Penalty Parameter:</label></td>
                            <td><input type="number" id="experience_penalty" name="experience_penalty" value="{{ app_data.get('experience_penalty', '100') }}" min="0" class="small-input" required></td>
                        </tr>
                        <tr>
                            <td><label for="penalty_outside_window">Early/Late Shift Penalty Parameter:</label></td>
                            <td><input type="number" id="penalty_outside_window" name="penalty_outside_window" value="{{ app_data.get('penalty_outside_window', '1000') }}" min="0" class="small-input" required></td>
                        </tr>
                        <tr>
                            <td><label for="gender_penalty">Inequal Gender Penalty Parameter:</label></td>
                            <td><input type="number" id="gender_penalty" name="gender_penalty" value="{{ app_data.get('gender_penalty', '10') }}" min="0" class="small-input" required></td>
                        </tr>
                        <tr>
                            <td><label for="penalty_for_same_time_slot">Same Time Slot Penalty Parameter:</label></td>
                            <td><input type="number" id="penalty_for_same_time_slot" name="penalty_for_same_time_slot" value="{{ app_data.get('penalty_for_same_time_slot', '30') }}" min="0" class="small-input" required></td>
                        </tr>
                    </table>
                </td>
                <td class="td-dark-padded" rowspan="2">
                    {% if app_data.not_enough_shifts %}
                    <label class="label-primary big line-break">There are only {{ app_data.persons | map(attribute='num_p_shifts') | map('int') | sum }} available shift spots, but {{ app_data.get('total_assignments_needed', '0') }} shift spots are required<br><br>
                        What you can do:
                        <ul>
                            <li>add more people to the team</li>
                            <li>reduce size of some shifts</li>
                            <li>increase number of shifts per person</li>
                          </ul> 
                        </label>
                    {% endif %}
                    {% if app_data.results and app_data.results.get('status', "") == "NOT FEASIBLE" %}
                    <label class="label-primary big line-break"><u>No solution feasible!</u> Possible reasons:
                          <ul>
                            <li>too few people available for some roles</li>
                            <li>too many time constraints on shifts</li>
                            <li>pre-assigned shift role not available</li>
                            <li>some parameters too far from default</li>
                          </ul> 
                          Try to:
                          <ul>
                            <li>allow some more roles for people</li>
                            <li>remove some hard time constraints</li>
                            <li>person can work pre-assigned shift</li>
                            <li>use default parameters</li>
                          </ul>
                        </label>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <table class="table-invisible">
                        <tr><td class="align-right">
                            <label for="solver_timeout_sec"><b>Stop optimizing after (sec):&nbsp;</b></label>
                            <input type="number" id="solver_timeout_sec" name="solver_timeout_sec" value="{{ app_data.get('solver_timeout_sec', '30') }}" class="small-input" min="0" required>
                            <input type="submit" value="Generate Shift Schedule!">
                        </td></tr>
                    </table>
                </td>
            </tr>
        </table>
        </form>
    </div>
    {% endif %}

    {% if app_data.results and app_data.results.get('status', "") != "NOT FEASIBLE" %}
    <table class="table-invisible">
        <tr>
            <td class="td-dark-padded">
                <h2 id="results" >Generated Shift Plan</h2>
                <h3>Statistics</h3>
                <table class="table-slim" border="1">
                    <tr>
                        <th>Criteria</th>
                        <th>Best score</th>
                        <th>Good score</th>
                        <th>Actual score</th>
                    </tr>
                    <!--<tr>
                        <td class="td-left-head">Solver Score</td>
                        <td>highest</td>
                        <td>
                            {% if app_data.results.get('stats', {}).get('status', "") == "OPTIMAL" %}
                            optimal
                            {% else %}
                            {{ app_data.results.get('stats', {}).get('score', 0.0) }}
                            {% endif %}
                        </td>
                    </tr>-->
                    <tr>
                        <td class="td-left-head">Distance Score</td>
                        <td>100</td>
                        <td>60</td>
                        <td class="{% if app_data.opt_max_shift_dist %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('max_shift_distance_score', 0.0) | round(2) }}</td>
                    </tr>
                    <tr>
                        <td class="td-left-head">Gender Imbalance</td>
                        <td>0</td>
                        <td>{{ (app_data.shift_params.get('num_shifts', '0') | int / 4) | ceil | int }}</td>
                        <td class="{% if app_data.opt_balance_gender %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('gender_parity_score', 0.0) }}</td>
                    </tr>
                    <tr>
                        <td class="td-left-head">Time Slot Repetitions</td>
                        <td>0</td>
                        <td>{{ (app_data.shift_params.get('num_shifts', '0') | int / 6) | ceil | int }}</td>
                        <td class="{% if app_data.opt_same_time_slots %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('time_slot_repetition_score', 0.0) }}</td>
                    </tr>
                    <tr>
                        <td class="td-left-head">Time Window Violations</td>
                        <td>0</td>
                        <td>1</td>
                        <td class="{% if app_data.opt_consider_travel %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('time_window_violation_score', 0.0) }}</td>
                    </tr>
                    <tr>
                        <td class="td-left-head">Experience Imbalances</td>
                        <td>0</td>
                        <td>{{ (app_data.shift_params.get('num_shifts', '0') | int / 2) | ceil | int }}</td>
                        <td class="{% if app_data.role_experience_required.values() | select('equalto', True) | list | length > 0 %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('experience_balance_score', 0.0) }}</td>
                    </tr>
                    <tr>
                        <td class="td-left-head">Missed Partners</td>
                        <td>0</td>
                        <td>0</td>
                        <td class="{% if app_data.opt_match_partners %}bold{% endif %}">{{ app_data.results.get('stats', {}).get('partner_matching_score', 0.0) }}</td>
                    </tr>
                </table>
                <h3>Overview</h3>
                <table border="1">
                    {% for row in app_data.results.get('shift_table', []) %}
                    <tr>
                        {% if loop.index == 1 %}
                        {% for column in row %}
                        <th><label>{{ column }}</label></th>
                        {% endfor %}
                        {% else %}
                        {% for column in row %}
                        {% if loop.index == 1 %}
                        <td class="td-left-head centered extra-padding"><label>{{ column }}</label></td>
                        {% else %}
                        <td class="centered extra-padding"><label>{{ column | replace(', ', '<br>') | safe }}</label></td>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </table>
                <h3>Person view</h3>
                <table border="1">
                    {% for row in app_data.results.get('people_table', []) %}
                    <tr>
                        {% if loop.index == 1 %}
                        {% for column in row %}
                        <th><label>{{ column }}</label></th>
                        {% endfor %}
                        {% else %}
                        {% for column in row %}
                        {% if loop.index == 1 %}
                        <td class="td-left-head centered extra-padding"><label>{{ column }}</label></td>
                        {% else %}
                        {# Check if the column contains an exclamation mark #}
                        {% set warning_class = 'td-warning' if '!' in column else '' %}
                        {# Remove all exclamation marks from the column #}
                        {% set cleaned_column = column.replace('!', '') %}
                        <td class="centered extra-padding {{ warning_class }}"><label>{{ cleaned_column | replace(', ', '<br>') | safe }}</label></td>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </table>                
            </td>
        </tr>
    </table>
    {% endif %}

    <script>
        function addNewRole() {
            const formElement = document.getElementById('add-role-form');
    
            // Check if the form element exists
            if (!formElement) {
                console.error('Form element with id "add-role-form" not found.');
                return;
            }

            var formData = new FormData(formElement);

            fetch('/add_new_shift_role', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.new_role_name) {
                    // Get the shifts table element
                    const table = document.querySelector('table[border="1"]');

                    // Create a new row for the new role
                    const newRow = document.createElement('tr');
                    
                    // Add role name cell
                    newRow.innerHTML += `<td class="centered">${data.new_role_name}</td>`;
                    
                    // Add experience balance checkbox
                    newRow.innerHTML += `
                        <td class="centered">
                            <label>balanced 
                                <input type="checkbox" name="experience_balance_${data.new_role_name}" ${data.role_experience_required[data.new_role_name] ? 'checked' : ''}>
                            </label>
                        </td>
                        <td></td>
                    `;

                    // Add shift counts for each shift
                    data.new_role_shifts.forEach((shift_count, index) => {
                        newRow.innerHTML += `<td class="centered"><input type="number" name="shift_${data.new_role_name}_${index}" value="${shift_count}" min="0" class="small-input"></td>`;
                    });

                    // Append the new row to the table
                    table.appendChild(newRow);
                }
            })
            .catch(error => console.error('Error adding new role:', error));
        }

        function toggleExperienceCheckbox(personIndex, role) {
            var availableCheckbox = document.getElementsByName(`roles_${personIndex}_${role}_available`)[0];
            var experiencedCheckbox = document.getElementsByName(`roles_${personIndex}_${role}_experienced`)[0];
            
            if (availableCheckbox && experiencedCheckbox) {
                if (availableCheckbox.checked) {
                    experiencedCheckbox.disabled = false;
                } else {
                    experiencedCheckbox.checked = false;
                    experiencedCheckbox.disabled = true;
                }
            }
        }

        function deletePerson(index) {
            fetch('/delete_person', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ index: index })
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      const row = document.getElementById(`row_${index}`);
                      if (row) {
                          row.remove();
                      }
                  }
              });
        }

        function addPerson() {
            fetch('/add_person', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const newPerson = data.person;
                    const table = document.getElementById('participant-table');
                    const newRow = document.createElement('tr');
                    const lastIndex = table.rows.length - 1;
                    newRow.id = `row_${lastIndex}`;
                    newRow.innerHTML = `
                        <td class="centered"><input type="text" name="name_${lastIndex}" value="${newPerson.name}" class="large-input"></td>
                        <td class="centered">
                            <select name="gender_${lastIndex}">
                                <option value="m" ${newPerson.gender === 'm' ? 'selected' : ''}>m</option>
                                <option value="w" ${newPerson.gender === 'w' ? 'selected' : ''}>w</option>
                                <option value="d" ${newPerson.gender === 'd' ? 'selected' : ''}>d</option>
                            </select>
                        </td>
                    `;

                    // Add role columns dynamically
                    const roleColumns = JSON.parse(document.getElementById('role-columns-data').textContent);
                    const roleExperienceRequired = data.role_experience_required || {};
                    
                    roleColumns.forEach(role => {
                        newRow.innerHTML += `
                            <td class="centered">
                                <label>Available
                                    <input type="checkbox" name="roles_${lastIndex}_${role}_available" checked>
                                </label>
                                ${roleExperienceRequired[role] ? `
                                    <label>Experienced
                                        <input type="checkbox" id="roles_${lastIndex}_${role}_experienced" name="roles_${lastIndex}_${role}_experienced" ${newPerson.experienced_roles.includes(role) ? 'checked' : ''}>
                                    </label>
                                ` : ''}
                            </td>
                        `;
                    });

                    // Continue with other fields
                    newRow.innerHTML += `
                        <td class="centered"><input type="text" name="arrival_time_${lastIndex}" value="${newPerson.arrival_time}" class="medium-input">
                            <label>hard
                                <input type="checkbox" name="arrival_hard_${lastIndex}" ${newPerson.arrival_hard ? 'checked' : ''}>
                            </label>
                            </td>
                        <td class="centered"><input type="text" name="departure_time_${lastIndex}" value="${newPerson.departure_time}" class="medium-input">
                            <label>hard
                                <input type="checkbox" name="departure_hard_${lastIndex}" ${newPerson.departure_hard ? 'checked' : ''}>
                            </label>
                        </td>
                        <td class="centered"><input type="number" name="num_p_shifts_${lastIndex}" value="${newPerson.num_p_shifts}" class="small-input"></td>
                        <td class="centered"><input type="text" name="assign_shifts_${lastIndex}" value="${newPerson.assign_shifts}" class="large-input"></td>
                        <td class="centered"><input type="text" name="veto_shifts_${lastIndex}" value="${newPerson.veto_shifts}" class="large-input"></td>
                        <td class="centered"><input type="text" name="preferred_partners_${lastIndex}" value="${newPerson.preferred_partners}" class="large-input"></td>
                        <td class="centered">
                            <button type="button" class="delete-btn" onclick="deletePerson(${lastIndex})">Delete</button>
                        </td>
                    `;
                    //<td class="centered"><input type="text" name="options_${lastIndex}" value="${newPerson.options}" class="large-input"></td>
                    table.appendChild(newRow);
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Attach event listeners to all input elements in the participant form
            const participantForm = document.getElementById('participant-form');
            
            participantForm.addEventListener('input', function(event) {
                submitFormData();
            });

            function submitFormData() {
                const formData = new FormData(participantForm);
                
                fetch('/change_person_table', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('label-num-persons').innerHTML = `&nbsp;&nbsp;${data.num_persons} persons&nbsp;&nbsp;`;
                    document.getElementById('label-num-genders').innerHTML = `(w: ${data.num_w}, m: ${data.num_m}, d: ${data.num_d})`;
                    document.getElementById('label-num-avail-shifts').innerHTML = `&nbsp;&nbsp;${data.num_avail_shifts} shift spots`;
                    console.log("Participant data saved successfully.");
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        }); 

        document.addEventListener("DOMContentLoaded", function() {
            // Attach event listeners to all input elements in the shift table form
            const shiftTableForm = document.getElementById('shifts-form');
            
            shiftTableForm.addEventListener('input', function(event) {
                submitShiftTableData();
            });

            function submitShiftTableData() {
                const formData = new FormData(shiftTableForm);
                
                fetch('/ajax_change_shift_table', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    // Update the labels dynamically
                    document.getElementById('label-total_assignments_needed').innerHTML = `${data.total_assignments_needed} shift spots`;
                    document.getElementById('label-recommended_nums_people').innerHTML = `/ at least ${data.recommended_nums_people} people with ${Math.ceil(data.total_assignments_needed / data.recommended_nums_people)} shifts recommended`;
                    document.getElementById('label-num-req-shifts').innerHTML = `&nbsp;&nbsp;(${data.total_assignments_needed} required)`;
                    
                    console.log("Shift table data saved successfully.");
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        });

        // Initialize checkboxes on page load
        document.addEventListener("DOMContentLoaded", function() {
            var persons = JSON.parse(document.getElementById('persons-data').textContent);
            var roleColumns = JSON.parse(document.getElementById('role-columns-data').textContent);
            
            persons.forEach(function(person, i) {
                roleColumns.forEach(function(role) {
                    toggleExperienceCheckbox(i, role);
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            var section = "{{ scroll_to }}";
            if (section) {
                var element = document.getElementById(section);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
    </script>
    <script type="application/json" id="persons-data">{{ app_data.persons | tojson }}</script>
    <script type="application/json" id="role-columns-data">{{ app_data.role_columns | tojson }}</script>    
</body>
</html>
